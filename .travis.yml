language: node_js
node_js:
  - "14"

branches:
  only:
    - master

cache: yarn

notifications:
  email: false

install:
  - yarn install --frozen-lockfile
  - cd $TRAVIS_BUILD_DIR/client && yarn install --frozen-lockfile
  - cd $TRAVIS_BUILD_DIR/server && yarn install --frozen-lockfile

jobs:
  include:
    - stage: Test
      name: "Lint"
      before_script:
        - cd $TRAVIS_BUILD_DIR
      script:
        - yarn lint
        - yarn lint:css

    - stage: Test
      name: "Test - Client"
      before_script:
        - cd $TRAVIS_BUILD_DIR/client
      script:
        - yarn test

    - stage: Test
      name: "Test - Server"
      before_script:
        - cd $TRAVIS_BUILD_DIR/server
      script:
        - yarn test

    - stage: Test
      name: "Test Coverage"
      before_script:
        - cd $TRAVIS_BUILD_DIR
      script:
        - yarn test:coverage
      after_script:
        # Upload coverage reports to Coveralls
        - COVERALLS_REPO_TOKEN=$COVERALLS_REPO_TOKEN yarn test:coverage:report

    - stage: Test
      name: "Storybook - Client"
      before_script:
        - cd $TRAVIS_BUILD_DIR/client
      script:
        # Run chromatic only when a build does not originate from a pull request (push build), or when it is a pull request build originating from a fork
        - |
          if [[ $TRAVIS_PULL_REQUEST_SLUG != $TRAVIS_REPO_SLUG ]]; then
            yarn run chromatic --exit-zero-on-changes
          fi

    - stage: Test
      name: "Lighthouse - Client"
      before_script:
        - cd $TRAVIS_BUILD_DIR/client
      script:
        - yarn build
        - yarn run lighthouse
      addons:
        chrome: stable

    - stage: Deploy
      deploy:
        provider: heroku
        api_key:
          secure: "IlWm0csumtKE5kNStV2hHdsDCyF/0LYCMXvfnpEr4cZrfV2ZKWXaqKoA3kXbMWJU+8ihoGy/8Vz4VbkYP0232wNZAeM4p9mC7RUcxR+Y/Rz1mU8aAQ1VFod17XNtQTpX1iXWbgt77zABiBJURdSyTCQDTgoC+GdV/rPQnbcsAbZTeChRcwgv1R5YxINNrHPFlXrvnzyFTajgq3ulRTpUSVGH50pbZ+FklF+W8uPbj+xQG8O/sOzKbuNmpdrFIgRsZBG8HM8WXJHQgISQ4R2y2974U5oZwNDyNC7QjlyJWvs21HOCYHZv6kKM4PiAL3lBtQ/g9Sj1r6lAFleqQeK9uHQvzBG6i+uTfcjfszmyj0CYGC8y4tlAXPu2KpMDXopa+CJi1k3TyqJvP/VkaHTkHVskZXSwo3sZL/u6V0NSbM0ObGzlOCPkrev7MMaZFIqEB5yWV3xN6YzVMIl1tsNwZnCVQKkTwtiOTCVuROI2gw763KNoN4ZpA8Sv9hi2lc0/VrMBihfAKnTmTq4vto789IB0wKo8XsHy1yGRaHXKKV3e3VlF1VeuQUlpCmCQn/sS2c7rCZJ1wfiMrAoerUlM1jIsLOZJcvOAnK/CRpkMYS6CZwl2wW91W9d7vgcZ/2qwkfS0Re8xD2rsk3Fsb5tWncGT/6B0H7GrXkGRC0suzcs="
        app: hongbomiao
        on:
          branch: master
